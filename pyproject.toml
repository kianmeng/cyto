[build-system]
# We can't use poetry-core, since there is a compatibility issue with
# the poetry-dynamic-versioning plug-in when run inside tox.
build-backend = "poetry.masonry.api"
# We use specific versions of dunamai and poetry-dynamic-versioning
# due to a bug in recent versions that raises "RuntimeError: Unable
# to detect version control system" when run through tox.
requires = [
  "poetry>=1.0.0",
  "dunamai==1.4.1",
  "poetry-dynamic-versioning==0.11.0",
]

[tool.poetry]
authors = ["Frederik Peter Aalund <fpa@sbtinstruments.com>"] 
description = "SBT Instruments' framework for Python-based applications" 
license = "MIT" 
name = "cyto" 
readme = "README.md" 
version = "0.0.0" # Placeholder (we use the poetry-dynamic-versioning plug-in)

[tool.poetry.dependencies]
anyio = "^2.0.2"
pydantic = {git = "https://github.com/kozlek/pydantic.git", rev = "e8d65f67a0671e9086a599243fc6820a90b74635"}
python = "^3.8"
toml = "^0.10.2"

[tool.poetry.dev-dependencies]
black = "^20.8b1"
isort = "^5.6.4"
mypy = "^0.790"
pre-commit = "^2.8.2"
pyfakefs = "^4.2.1"
pylint = "^2.6.0"
pytest = "^6.1.2"
pytest-cov = "^2.10.1"
taskipy = "^1.4.0"
# We only use rope to give Visual Studio Code users a better
# out-of-the-box experience. For, e.g., refactoring.
# In other words, rope is not part of the QA tooling itself.
pydocstyle = "^5.1.1"
rope = "^0.18.0"

[tool.poetry-dynamic-versioning]
enable = true

[tool.taskipy.tasks]
black = "black cyto tests"
isort = "isort cyto tests"
mypy = "mypy cyto tests"
pre-commit = "pre-commit run --all-files"
pylint = "pylint cyto tests"

[tool.tox]
legacy_tox_ini = """
[tox]
isolated_build = true
envlist = clean,py38,py39,coverage
requires =
    tox-poetry-installer[poetry] == 0.6.0

[testenv]
require_locked_deps = true
locked_deps =
    pytest
    pytest-cov
    pyfakefs

[testenv:{py38,py39}]
depends = clean
commands =
    pytest --cov=cyto --cov-append --cov-report=term-missing {env:PYTEST_ARGS:}

[testenv:clean]
basepython = python3.8
skip_install = true
commands = coverage erase

[testenv:coverage]
basepython = python3.8
depends = py38,py39
skip_install = true
commands =
    coverage html --precision=2
    coverage report --precision=2 --fail-under=90
"""

[tool.black]
target-version = ['py38']

[tool.isort]
profile = 'black'

[tool.pylint.master]
# i,j,k: You can use this for an integer index in a loop.
# fs: We use this in the tests to get a pyfakefs file system reference.
#     Since pytest's dependency injection is name based, we have to use
#     this exact argument name.
# tg: You can use this for an `anyio.TaskGroup`.
good-names = 'i,j,k,fs,tg' # Default is 'i,j,k,ex,Run,_'
# Increase the default values a bit. Yes, this may hurt maintainability
# ever so slightly but it increases the speed of development.
max-args = '7' # Default is 5
max-attributes = '12' # Default is 7
# Match black's default max line length
max-line-length = '88' # Default is 100

[tool.pylint.similarities]
# Imports are often duplicated. If two different files use a lot of
# the same imports, there is just no way around it. Therefore, we
# simply ignore import statements completely when we look for duplicate
# code.
ignore-imports = 'y'

[tool.pylint.'messages control']
# Note that there is an ongoing discussion about, the current
# pylint defaults:
#     https://github.com/PyCQA/pylint/issues/3512
#
# It's also interesting to note that the pylint authors disable
# some checks for the official pylint repo:
#     https://github.com/PyCQA/pylint/blob/master/pylintrc#L56

### IF YOU ENABLE A PYLINT CHECK THEN EXPLAIN WHY BELOW
enable = '''
'''

### IF YOU DISABLE A PYLINT CHECK THEN EXPLAIN WHY BELOW
#
# fixme: We use "TODO: " to note areas that we can improve.
#     It's nice to have this directly in the code in a way that
#     we can easily search for.
#     Related to: https://github.com/PyCQA/pylint/issues/2874
#
# missing-module-docstring,
# missing-class-docstring,
# missing-function-docstring: pydocstyle handles all this
#     See: https://pylint.readthedocs.io/en/latest/faq.html#i-am-using-another-popular-linter-alongside-pylint-which-messages-should-i-disable-to-avoid-duplicates
disable = '''
  fixme,
  missing-module-docstring,
  missing-class-docstring,
  missing-function-docstring,
'''
